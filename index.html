<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Weather Station</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #e0e0e0;
      text-align: center;
      padding: 30px;
      transition: background 0.5s, color 0.5s;
    }
    h1 { color: inherit; }
    .status-card {
      display: inline-block;
      margin: 10px 0 20px 0;
      padding: 10px 20px;
      border-radius: 12px;
      background: #1e1e1e;
      color: inherit;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    .card {
      display: inline-block;
      width: 220px;
      margin: 15px;
      padding: 20px;
      border-radius: 12px;
      background: #1e1e1e;
      color: inherit;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      transition: background 0.5s, color 0.5s;
    }
    .value {
      font-size: 24px;
      margin-top: 10px;
      color: #4fc3f7;
    }
    .status-dot {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
    }
    canvas {
      margin-top: 20px;
      background: #1e1e1e;
      border-radius: 12px;
      padding: 15px;
      transition: background 0.3s;
    }
    .buttons { margin: 20px; }
    button {
      margin: 8px;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s, color 0.3s;
    }
    .dark-mode { background: #121212; color: #e0e0e0; }
    .light-mode { background: #f9f9f9; color: #333; }
    .light-mode .card, .light-mode .status-card { background: #fff; color: #333; }
    .light-mode canvas { background: #fff; }
    .toggle-btn { background: #4fc3f7; color: #000; }
    .csv-btn { background: #81c784; color: #000; }
  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark-mode">
  <h1>ESP32 Weather Station Dashboard</h1>

  <!-- ESP32 Status below title -->
  <div class="status-card" id="espStatusCard">
    <span class="status-dot" id="espDot" style="background:red;"></span>
    <span>ESP32 Status: </span><span class="value" id="espStatus">Offline</span>
  </div>

  <div class="buttons">
    <button class="toggle-btn" onclick="toggleDarkMode()">üåó Toggle Dark Mode</button>
    <button class="csv-btn" onclick="downloadCSV()">‚¨áÔ∏è Download CSV</button>
  </div>

  <!-- Sensor status cards (including Rain Duration) -->
  <div class="card"><h3>Temperature</h3><div class="value" id="temp">-- ¬∞C</div></div>
  <div class="card"><h3>Humidity</h3><div class="value" id="hum">-- %</div></div>
  <div class="card"><h3>Pressure</h3><div class="value" id="pressure">-- hPa</div></div>
  <div class="card"><h3>Rain</h3><div class="value" id="rain">--</div></div>
  <div class="card"><h3>Rain Duration</h3><div class="value" id="rainDuration">-- min in last 30 min</div></div>
  <div class="card"><h3>Wind Speed</h3><div class="value" id="windspeed">-- m/s</div></div>
  <div class="card"><h3>Wind Direction</h3><div class="value" id="winddir">-- ¬∞</div></div>

  <!-- Charts -->
  <canvas id="tempChart" width="400" height="200"></canvas>
  <canvas id="humChart" width="400" height="200"></canvas>
  <canvas id="windChart" width="400" height="200"></canvas>
  <canvas id="pressureChart" width="400" height="200"></canvas>

  <script>
    const broker = "wss://broker.hivemq.com:8884/mqtt";
    const clientId = "ESP32Dashboard-" + Math.random().toString(16).substr(2, 8);
    const client = mqtt.connect(broker, { clientId });

    let latestTemp = null, latestHum = null, latestWind = null, latestPressure = null;
    let latestRain = null;
    let chartData = { time: [], temp: [], hum: [], wind: [], pressure: [], rain: [] };
    let rainTimestamps = [];
    const MAX_POINTS = 180;

    function createChart(ctx, label, color, step=false) {
      return new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [{ label, data: [], borderColor: color, backgroundColor: color+"33", borderWidth: 2, tension: step?0:0.3, stepped: step, fill: true }] },
        options: {
          responsive: true,
          scales: {
            x: { ticks: { color: "#bbb" }, grid: { color: "#333" } },
            y: { beginAtZero: true, ticks: { color: "#bbb" }, grid: { color: "#333" } }
          },
          plugins: { legend: { labels: { color: "#fff" } } }
        }
      });
    }

    const tempChart = createChart(document.getElementById("tempChart"), "Temperature (¬∞C)", "#ff5252");
    const humChart = createChart(document.getElementById("humChart"), "Humidity (%)", "#4fc3f7");
    const windChart = createChart(document.getElementById("windChart"), "Wind Speed (m/s)", "#81c784");
    const pressureChart = createChart(document.getElementById("pressureChart"), "Pressure (hPa)", "#ba68c8");

    client.on("connect", () => {
      console.log("Connected to MQTT");
      updateESPStatus(true);
      client.subscribe("esp32/temp");
      client.subscribe("esp32/hum");
      client.subscribe("esp32/pressure");
      client.subscribe("esp32/rain");
      client.subscribe("esp32/windspeed");
      client.subscribe("esp32/winddir");
    });

    client.on("close", () => updateESPStatus(false));

    client.on("message", (topic, message) => {
      const value = message.toString();
      switch (topic) {
        case "esp32/temp": document.getElementById("temp").innerText = value + " ¬∞C"; latestTemp = parseFloat(value); break;
        case "esp32/hum": document.getElementById("hum").innerText = value + " %"; latestHum = parseFloat(value); break;
        case "esp32/pressure": document.getElementById("pressure").innerText = value + " hPa"; latestPressure = parseFloat(value); break;
        case "esp32/rain":
          document.getElementById("rain").innerText = (value == "0") ? "üåß Yes" : "‚òÄÔ∏è No";
          latestRain = (value == "0") ? 1 : 0; 
          break;
        case "esp32/windspeed": document.getElementById("windspeed").innerText = value + " m/s"; latestWind = parseFloat(value); break;
        case "esp32/winddir": document.getElementById("winddir").innerText = value + " ¬∞"; break;
      }
    });

    setInterval(() => {
      const now = new Date().toLocaleTimeString();

      function updateChart(chart, dataArray, value) {
        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(value);
        dataArray.push(value);
        if (chart.data.labels.length > MAX_POINTS) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
          dataArray.shift();
        }
        chart.update();
      }

      if (latestTemp !== null) updateChart(tempChart, chartData.temp, latestTemp);
      if (latestHum !== null) updateChart(humChart, chartData.hum, latestHum);
      if (latestWind !== null) updateChart(windChart, chartData.wind, latestWind);
      if (latestPressure !== null) updateChart(pressureChart, chartData.pressure, latestPressure);


      }

      updateRainDuration();
    }, 5000);

    function toggleDarkMode() {
      document.body.classList.toggle("light-mode");
      document.body.classList.toggle("dark-mode");

      let dark = document.body.classList.contains("dark-mode");
      [tempChart, humChart, windChart, pressureChart, rainChart].forEach(chart => {
        chart.options.scales.x.ticks.color = dark ? "#bbb" : "#333";
        chart.options.scales.x.grid.color = dark ? "#333" : "#ddd";
        chart.options.scales.y.ticks.color = dark ? "#bbb" : "#333";
        chart.options.scales.y.grid.color = dark ? "#333" : "#ddd";
        chart.options.plugins.legend.labels.color = dark ? "#fff" : "#333";
        chart.update();
      });
    }

    function downloadCSV() {
      let csv = "Time,Temperature,Humidity,Wind Speed,Pressure,Rain\n";
      for (let i = 0; i < chartData.time.length; i++) {
        csv += `${chartData.time[i]},${chartData.temp[i]||""},${chartData.hum[i]||""},${chartData.wind[i]||""},${chartData.pressure[i]||""},${chartData.rain[i]||""}\n`;
      }
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "weather_history.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateESPStatus(online) {
      const statusEl = document.getElementById("espStatus");
      const dotEl = document.getElementById("espDot");
      if (online) {
        statusEl.innerText = "Online";
        dotEl.style.background = "green";
      } else {
        statusEl.innerText = "Offline";
        dotEl.style.background = "red";
      }
    }

    setInterval(() => updateESPStatus(client.connected), 3000);

    function updateRainDuration() {
      const now = new Date();
      const THIRTY_MIN = 30 * 60 * 1000;
      rainTimestamps = rainTimestamps.filter(ts => now - ts <= THIRTY_MIN);
      const rainDuration = rainTimestamps.length * 5 / 60; // each tick = 5s
      document.getElementById("rainDuration").innerText = `${Math.round(rainDuration)} min in last 30 min`;
    }
  </script>
</body>
</html>

