<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Weather Station</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #e0e0e0;
      text-align: center;
      padding: 30px;
      transition: background 0.5s, color 0.5s;
    }
    h1 { color: inherit; }
    .status-card {
      display: inline-block;
      margin: 10px 0 20px 0;
      padding: 10px 20px;
      border-radius: 12px;
      background: #1e1e1e;
      color: inherit;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    .card {
      display: inline-block;
      width: 220px;
      margin: 15px;
      padding: 20px;
      border-radius: 12px;
      background: #1e1e1e;
      color: inherit;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    .value {
      font-size: 24px;
      margin-top: 10px;
      color: #4fc3f7;
    }
    .status-dot {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
    }
    canvas {
      margin-top: 20px;
      background: #1e1e1e;
      border-radius: 12px;
      padding: 15px;
    }
    .buttons { margin: 20px; }
    button {
      margin: 8px;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .toggle-btn { background: #4fc3f7; color: #000; }
    .csv-btn { background: #81c784; color: #000; }
  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark-mode">
  <h1>ESP32 Weather Station Dashboard</h1>

  <!-- ESP32 Status -->
  <div class="status-card" id="espStatusCard">
    <span class="status-dot" id="espDot" style="background:red;"></span>
    <span>ESP32 Status: </span><span class="value" id="espStatus">Offline</span>
  </div>

  <div class="buttons">
    <button class="toggle-btn" onclick="toggleDarkMode()">üåó Toggle Dark Mode</button>
    <button class="csv-btn" onclick="downloadCSV()">‚¨áÔ∏è Download CSV</button>
    <button class="csv-btn" onclick="testRain()">üåß Test Rain</button> <!-- ‚úÖ Test Button -->
  </div>

  <!-- Sensor Cards -->
  <div class="card"><h3>Temperature</h3><div class="value" id="temp">-- ¬∞C</div></div>
  <div class="card"><h3>Humidity</h3><div class="value" id="hum">-- %</div></div>
  <div class="card"><h3>Pressure</h3><div class="value" id="pressure">-- hPa</div></div>
  <div class="card"><h3>Rain</h3><div class="value" id="rain">--</div></div>
  <div class="card"><h3>Rain Duration</h3><div class="value" id="rainDuration">-- min in last 30 min</div></div>
  <div class="card"><h3>Wind Speed</h3><div class="value" id="windspeed">-- m/s</div></div>

  <!-- Charts -->
  <canvas id="tempChart" width="400" height="200"></canvas>
  <canvas id="humChart" width="400" height="200"></canvas>
  <canvas id="windChart" width="400" height="200"></canvas>
  <canvas id="pressureChart" width="400" height="200"></canvas>

<script>
  const broker = "wss://broker.hivemq.com:8884/mqtt";
  const clientId = "ESP32Dashboard-" + Math.random().toString(16).substr(2, 8);
  const client = mqtt.connect(broker, { clientId });

  let latestTemp = null, latestHum = null, latestWind = null, latestPressure = null;
  let latestRain = null;
  let chartData = { time: [], temp: [], hum: [], wind: [], pressure: [], rain: [] };
  let rainTimestamps = [];
  const MAX_POINTS = 180;

  // ---- Notification Setup ----
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  function sendRainEmail() {
    fetch("http://localhost:3000/send-alert", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        subject: "üåß Rain Detected!",
        message: "Rain has been detected by the ESP32 Weather Station."
      })
    })
    .then(res => res.text())
    .then(data => console.log("‚úÖ Email Response:", data))
    .catch(err => console.error("‚ùå Email Error:", err));
  }

  function testRain() {
    document.getElementById("rain").innerText = "üåß Yes (Test)";
    latestRain = 1;
    sendRainNotification();  // Browser notification
    sendRainEmail();         // üìß Gmail notification
    console.log("‚úÖ Test Rain triggered manually");

    // Auto reset logic...
  }


  // ---- Chart.js Setup ----
  function createChart(ctx, label, color) {
    return new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{ label, data: [], borderColor: color, fill: true, backgroundColor: color+"33" }] },
      options: { responsive: true, animation: false, scales: { y: { beginAtZero: true } } }
    });
  }

  const tempChart = createChart(document.getElementById("tempChart"), "Temperature (¬∞C)", "#ff5252");
  const humChart = createChart(document.getElementById("humChart"), "Humidity (%)", "#4fc3f7");
  const windChart = createChart(document.getElementById("windChart"), "Wind Speed (m/s)", "#81c784");
  const pressureChart = createChart(document.getElementById("pressureChart"), "Pressure (hPa)", "#ba68c8");

  // ---- MQTT ----
  client.on("connect", () => {
    updateESPStatus(true);
    client.subscribe("esp32/temp");
    client.subscribe("esp32/hum");
    client.subscribe("esp32/pressure");
    client.subscribe("esp32/rain");
    client.subscribe("esp32/windspeed");
    client.subscribe("esp32/winddir");
  });
  client.on("close", () => updateESPStatus(false));

  client.on("message", (topic, message) => {
    const value = message.toString();
    switch (topic) {
      case "esp32/temp": latestTemp = parseFloat(value); document.getElementById("temp").innerText = value+" ¬∞C"; break;
      case "esp32/hum": latestHum = parseFloat(value); document.getElementById("hum").innerText = value+" %"; break;
      case "esp32/pressure": latestPressure = parseFloat(value); document.getElementById("pressure").innerText = value+" hPa"; break;
      case "esp32/rain":
        document.getElementById("rain").innerText = (value=="0") ? "üåß Yes" : "‚òÄÔ∏è No";
        if (value=="0") { latestRain=1; sendRainNotification(); } else latestRain=0;
        break;
      case "esp32/windspeed": latestWind=parseFloat(value); document.getElementById("windspeed").innerText=value+" m/s"; break;
      case "esp32/winddir": document.getElementById("winddir").innerText=value+" ¬∞"; break;
    }
  });

  // ---- History Save/Load ----
  function saveHistory(key, chart) {
    localStorage.setItem(key, JSON.stringify({
      labels: chart.data.labels,
      data: chart.data.datasets[0].data
    }));
  }

  function loadHistory(key, chart) {
    const saved = localStorage.getItem(key);
    if (saved) {
      const parsed = JSON.parse(saved);
      chart.data.labels = parsed.labels || [];
      chart.data.datasets[0].data = parsed.data || [];
      chart.update();
    }
  }

  // ---- Chart Update Loop ----
  setInterval(() => {
    const now = new Date().toLocaleTimeString();
    function updateChart(chart, value, key) {
      chart.data.labels.push(now);
      chart.data.datasets[0].data.push(value);
      if (chart.data.labels.length > MAX_POINTS) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
      saveHistory(key, chart);
    }

    if (latestTemp!==null) updateChart(tempChart, latestTemp, "tempHistory");
    if (latestHum!==null) updateChart(humChart, latestHum, "humHistory");
    if (latestWind!==null) updateChart(windChart, latestWind, "windHistory");
    if (latestPressure!==null) updateChart(pressureChart, latestPressure, "pressureHistory");

    if (latestRain===1) rainTimestamps.push(new Date());
    updateRainDuration();
  }, 5000);

  // ---- Helpers ----
  function updateESPStatus(online) {
    const statusEl=document.getElementById("espStatus");
    const dotEl=document.getElementById("espDot");
    if (online) { statusEl.innerText="Online"; dotEl.style.background="green"; }
    else { statusEl.innerText="Offline"; dotEl.style.background="red"; }
  }

  // ---- Test Rain Simulation with Auto Reset ----
  function testRain() {
    // Simulate rain detected
    document.getElementById("rain").innerText = "üåß Yes (Test)";
    latestRain = 1;
    sendRainNotification();  // üîî trigger notification
    console.log("‚úÖ Test Rain triggered manually");

  // Disable button temporarily
    const btn = document.querySelector("button[onclick='testRain()']");
    btn.disabled = true;
    btn.innerText = "üåß Testing...";

  // Auto reset back to normal after 5 seconds
    setTimeout(() => {
      document.getElementById("rain").innerText = "‚òÄÔ∏è No (Normal)";
      latestRain = 0;
      console.log("‚òÄÔ∏è Test Rain reset back to normal");

      // Re-enable button
      btn.disabled = false;
      btn.innerText = "üåß Test Rain";
    }, 5000);
  }

  function updateRainDuration() {
    const now=new Date();
    const THIRTY_MIN=30*60*1000;
    rainTimestamps=rainTimestamps.filter(ts => now-ts<=THIRTY_MIN);
    const rainDuration=rainTimestamps.length*5/60;
    document.getElementById("rainDuration").innerText=`${Math.round(rainDuration)} min in last 30 min`;
  }

  function downloadCSV() {
    let csv="Time,Temperature,Humidity,Wind,Pressure,Rain\n";
    const len=tempChart.data.labels.length;
    for (let i=0;i<len;i++) {
      csv+=`${tempChart.data.labels[i]},${tempChart.data.datasets[0].data[i]||""},${humChart.data.datasets[0].data[i]||""},${windChart.data.datasets[0].data[i]||""},${pressureChart.data.datasets[0].data[i]||""},${latestRain||""}\n`;
    }
    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="weather_history.csv"; a.click();
    URL.revokeObjectURL(url);
  }

  // ---- Restore History on Page Load ----
  window.onload=()=> {
    loadHistory("tempHistory", tempChart);
    loadHistory("humHistory", humChart);
    loadHistory("windHistory", windChart);
    loadHistory("pressureHistory", pressureChart);
  };
</script>
</body>
</html>

